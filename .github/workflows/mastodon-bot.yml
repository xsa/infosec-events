name: Mastodon Bot

on:
  push:
    branches: [main]
  schedule:
    # Weekly digest every Monday at 08:00 UTC
    - cron: "0 8 * * 1"
  workflow_dispatch:
    inputs:
      mode:
        description: "Mode to run (digest or notify)"
        required: true
        default: digest
        type: choice
        options: [digest, notify]

jobs:
  # ---------------------------------------------------------------------------
  # Weekly digest — runs on schedule (and manual trigger)
  # ---------------------------------------------------------------------------
  digest:
    name: Weekly Digest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'digest')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Post weekly digest
        env:
          MASTODON_TOKEN: ${{ secrets.MASTODON_TOKEN }}
          MASTODON_BASE_URL: ${{ secrets.MASTODON_BASE_URL }}
        run: python scripts/mastodon_bot.py digest

  # ---------------------------------------------------------------------------
  # New event notification — runs on every push to main (by a human)
  # ---------------------------------------------------------------------------
  notify:
    name: New Event Notification
    if: github.event_name == 'push' && github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 5  # Need enough history to find last human commit

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Extract newly added event rows
        id: diff
        run: |
          # git show handles both regular and merge commits correctly
          ADDED=$(git show -m --format="" ${{ github.sha }} -- README.md | python3 -c "
          import sys, json, re

          LINK_RE = re.compile(r'\[([^\]]*)\]\(([^)]+)\)')
          rows = []
          for line in sys.stdin.buffer.read().decode('utf-8').splitlines():
              if not line.startswith('+|'):
                  continue
              line = line[1:]  # strip leading +
              if re.match(r'^\|[-: |]+\|$', line):
                  continue
              if 'Event Name' in line:
                  continue
              cells = [c.strip() for c in line.strip('|').split('|')]
              if len(cells) < 2:
                  continue
              rows.append(cells)
          print(json.dumps(rows, ensure_ascii=False))
          ")
          echo "added=$ADDED" >> $GITHUB_OUTPUT

      - name: Post new event notification
        if: steps.diff.outputs.added != '[]'
        env:
          MASTODON_TOKEN: ${{ secrets.MASTODON_TOKEN }}
          MASTODON_BASE_URL: ${{ secrets.MASTODON_BASE_URL }}
        run: |
          python scripts/mastodon_bot.py notify --added '${{ steps.diff.outputs.added }}'
